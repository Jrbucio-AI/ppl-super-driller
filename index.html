<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PPL Super Driller ‚Äî Flashcards ‚Ä¢ SRS ‚Ä¢ Exam ‚Ä¢ Pomodoro</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121722;--card:#171d29;--ink:#e8eef7;--muted:#9fb0c7;--accent:#6ec2ff;
  --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--edge:#243042;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f14,#0b0f14 60%,#0e141c);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1080px;margin:28px auto;padding:0 16px}
h1{font-size:28px;margin:0 0 14px}h2{font-size:18px;margin:0 0 10px;color:var(--muted)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tab{background:#0f141d;border:1px solid var(--edge);color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer}
.tab.active{background:var(--card);box-shadow:0 0 0 1px var(--edge) inset}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:16px}
button{background:#0f141d;border:1px solid var(--edge);color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
button:hover{border-color:#344760}button.primary{background:var(--accent);border-color:#2e7bb6;color:#061626}
button.ghost{background:transparent;border:1px dashed var(--edge)}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--edge);background:#0f141d;color:var(--ink)}
.row{display:flex;gap:8px;flex-wrap:wrap}.grow{flex:1}.right{margin-left:auto}
.kpis{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.kpi{background:#0f141d;border:1px solid var(--edge);border-radius:12px;padding:8px 12px}
.q{font-weight:700;font-size:20px;margin:8px 0}
.a{margin-top:8px;color:#cfe4ff}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--edge);background:#0f141d;margin-right:6px}
.mc{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.sep{height:1px;background:linear-gradient(90deg,transparent,#243042,transparent);margin:12px 0}
.center{display:flex;align-items:center;justify-content:center}
kbd{border:1px solid var(--edge);border-bottom-width:2px;border-radius:6px;padding:2px 6px;background:#0f141d}
.modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:20px;z-index:20}
.modal .box{max-width:900px;width:100%;background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:16px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px dashed var(--edge);padding:6px 8px;text-align:left}
.tag{background:#0f141d;border:1px solid var(--edge);padding:4px 8px;border-radius:999px;cursor:pointer;margin:2px}
.tag.active{background:#223148}
.statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.stat{background:#0f141d;border:1px solid var(--edge);padding:10px;border-radius:12px}
.warn{color:var(--warn)}.ok{color:var(--ok)}.err{color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è PPL Super Driller <span class="small">Flashcards ‚Ä¢ Explanations ‚Ä¢ SRS ‚Ä¢ Exam ‚Ä¢ Pomodoro</span></h1>

  <div class="toolbar">
    <button class="tab active" data-tab="study">Study</button>
    <button class="tab" data-tab="exam">Exam</button>
    <button class="tab" data-tab="srs">SRS</button>
    <button class="tab" data-tab="timer">Pomodoro</button>
    <button class="tab" data-tab="todo">To-Do</button>
    <button class="right" id="helpBtn">Help</button>
  </div>

  <!-- STUDY -->
  <section id="study" class="card">
    <div class="row">
      <div class="grow">
        <h2>Flashcards (with ‚ÄúWhy‚Äù explanations)</h2>
        <div class="small">Filter by topic, show answers, mark right/wrong, and learn with simple explanations.</div>
      </div>
      <div class="row">
        <button id="shuffle">Shuffle</button>
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <select id="filterTag" class="grow">
        <option value="">All Topics</option>
      </select>
      <input id="searchBox" class="grow" placeholder="Search text‚Ä¶ (e.g., carb ice, Vx)">
      <button id="resetStats">Reset Stats</button>
    </div>

    <div class="kpis">
      <div class="kpi">Card <span id="idx">0</span>/<span id="total">0</span></div>
      <div class="kpi">Correct: <span id="ok">0</span></div>
      <div class="kpi">Wrong: <span id="bad">0</span></div>
      <div class="kpi">Streak: <span id="streak">0</span></div>
    </div>

    <div id="cardArea">
      <div class="badge" id="topicBadge">‚Äî</div>
      <div class="q" id="q"></div>
      <div id="choices" class="mc"></div>
      <div class="a" id="a" style="display:none"></div>
      <details id="whyBox" style="margin-top:6px;display:none">
        <summary>Why (simple explanation)</summary>
        <div id="why" class="small"></div>
      </details>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="show">Show Answer</button>
      <button id="right">I was Right ‚úÖ</button>
      <button id="wrong">I was Wrong ‚ùå</button>
      <div class="grow"></div>
      <button id="editBtn" class="ghost">Edit</button>
      <button id="addBtn" class="ghost">Add</button>
      <button id="importBtn" class="ghost">Import</button>
      <button id="exportBtn" class="ghost">Export</button>
      <input type="file" id="fileInput" accept=".json,.csv" style="display:none">
    </div>
  </section>

  <!-- EXAM -->
  <section id="exam" class="card" style="display:none">
    <h2>Exam Mode</h2>
    <div class="row">
      <select id="examTag" class="grow"><option value="">All Topics</option></select>
      <input id="examCount" type="number" min="5" max="120" value="30" style="max-width:140px">
      <select id="examTime" style="max-width:160px">
        <option value="45">45 min</option>
        <option value="60">60 min</option>
        <option value="90">90 min</option>
        <option value="120" selected>120 min</option>
      </select>
      <button id="startExam" class="primary">Start Exam</button>
      <button id="endExam" style="display:none">End & Grade</button>
    </div>
    <div class="sep"></div>
    <div id="examInfo" class="small"></div>
    <div id="examArea"></div>
    <div id="examResult"></div>
  </section>

  <!-- SRS -->
  <section id="srs" class="card" style="display:none">
    <h2>Spaced Repetition (Leitner)</h2>
    <div class="small">Practice only the cards that are ‚Äúdue.‚Äù Marking a card right moves it to a higher bucket with a longer delay.</div>
    <div class="statgrid" style="margin-top:8px">
      <div class="stat">Due Today: <b id="dueToday">0</b></div>
      <div class="stat">Total in SRS: <b id="srsTotal">0</b></div>
      <div class="stat">Avg Bucket: <b id="avgBucket">0</b></div>
      <div class="stat">Next Due: <b id="nextDue">‚Äî</b></div>
    </div>
    <div class="sep"></div>
    <div id="srsArea"></div>
    <div class="row" style="margin-top:8px">
      <button id="srsShow">Show</button>
      <button id="srsRight">Right ‚úÖ</button>
      <button id="srsWrong">Wrong ‚ùå</button>
      <button id="srsSkip">Skip</button>
    </div>
  </section>

  <!-- Pomodoro -->
  <section id="timer" class="card" style="display:none">
    <h2>Pomodoro</h2>
    <div class="center" style="font-size:48px;margin:10px 0"><span id="clock">25:00</span></div>
    <div class="row">
      <button id="startStop">Start</button>
      <button id="reset">Reset</button>
      <select id="mode">
        <option value="25">Focus 25</option>
        <option value="50">Deep 50</option>
        <option value="5">Break 5</option>
        <option value="10">Break 10</option>
      </select>
      <div class="kpi">Blocks: <span id="blocks">0</span></div>
    </div>
  </section>

  <!-- To-Do -->
  <section id="todo" class="card" style="display:none">
    <h2>To-Do (Today)</h2>
    <div class="row">
      <input id="todoInput" class="grow" placeholder="Add a task‚Ä¶ e.g., 30 Q on Weather + 25 on Systems">
      <button id="addTodo">Add</button>
    </div>
    <ul id="todos" class="list" style="list-style:none;padding:0;margin:8px 0"></ul>
    <div class="small">Click a task to toggle done. üóëÔ∏è deletes.</div>
  </section>

  <!-- HELP MODAL -->
  <div class="modal" id="helpModal">
    <div class="box">
      <div class="row"><h2>How to use (Simple)</h2><button id="closeHelp" class="right">Close</button></div>
      <div class="sep"></div>
      <ol>
        <li><b>Study:</b> See a question, try it, press <i>Show Answer</i>. Read the <b>Why</b> for a simple explanation. Mark ‚úÖ or ‚ùå.</li>
        <li><b>Filter:</b> Pick a topic from the dropdown or search by words.</li>
        <li><b>Import:</b> Upload your own cards (JSON or CSV) or paste text. Columns: <code>question,answer,choices,why,tag</code>. Choices can be separated by <code>;</code>.</li>
        <li><b>Exam:</b> Choose topic & count, start a timed test, then grade and review mistakes.</li>
        <li><b>SRS:</b> Practice ‚Äúdue‚Äù cards only. Right moves up buckets (1‚Üí5), wrong resets. Buckets wait: 1d, 2d, 4d, 7d, 14d.</li>
        <li><b>Pomodoro:</b> Use 25 or 50 minutes for deep focus; take breaks; watch blocks go up.</li>
        <li><b>To-Do:</b> Keep your study checklist here.</li>
        <li><b>Shortcuts:</b> <kbd>Space</kbd> show, <kbd>‚Üê/‚Üí</kbd> prev/next, <kbd>1..4</kbd> pick MC, <kbd>Y</kbd>/<kbd>N</kbd> right/wrong.</li>
      </ol>
      <div class="sep"></div>
      <details>
        <summary>Paste CSV here (optional)</summary>
        <textarea id="pasteArea" rows="6" placeholder="question,answer,choices,why,tag&#10;When is carb ice likely?,20‚Äì70¬∞F with high humidity,below freezing;20‚Äì70¬∞F with high humidity;32‚Äì50¬∞F low humidity,Moist air + venturi cooling causes ice even above freezing,Weather"></textarea>
        <div class="row" style="margin-top:6px">
          <button id="importFromPaste" class="primary">Import from Paste</button>
        </div>
      </details>
      <div class="sep"></div>
      <div class="small">Note: I can‚Äôt bundle paid/third-party question banks. If you own licensed material, you can import your own CSV/JSON for personal study.</div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d} };
const todayStr = (d=new Date())=>d.toISOString().substring(0,10);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function csvParse(text){
  const rows=text.trim().split(/\r?\n/);
  const out=[];
  for(const r of rows){
    // naive CSV split by comma unless in quotes; support semicolons for choices
    const cols=[]; let cur='',inQ=false;
    for(let i=0;i<r.length;i++){
      const ch=r[i];
      if(ch==='\"'){ inQ=!inQ; continue }
      if(ch===',' && !inQ){ cols.push(cur.trim()); cur=''; continue }
      cur+=ch;
    }
    cols.push(cur.trim());
    const [q,a,choices,why,tag] = cols;
    if(!q||!a) continue;
    const obj={q,a};
    if(choices){ obj.choices=choices.split(';').map(s=>s.trim()).filter(Boolean) }
    if(why) obj.why=why;
    if(tag) obj.tag=tag;
    out.push(obj);
  }
  return out;
}
function idgen(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}

/* ---------- Sample Deck (original content) ---------- */
const SAMPLE = [{"q": "Day VFR fuel reserve for airplanes?", "a": "At least 30 minutes at normal cruise after reaching the first point of intended landing.", "why": "14 CFR 91.151 requires 30 min (day) and 45 min (night) reserve for airplanes, considering wind and forecast weather.", "tag": "Regulations", "choices": ["20 minutes", "30 minutes", "45 minutes"]}, {"q": "Night VFR fuel reserve for airplanes?", "a": "At least 45 minutes at normal cruise after your first intended landing.", "why": "Per 91.151, airplanes at night need 45 minutes of reserve fuel at normal cruise.", "tag": "Regulations", "choices": ["30 minutes", "45 minutes", "60 minutes"]}, {"q": "Passenger-carrying night currency requires‚Ä¶", "a": "3 takeoffs and 3 landings to a full stop in the period 1 hour after sunset to 1 hour before sunrise within the previous 90 days.", "why": "61.57(b): for carrying passengers during that night period, you need 3 T/LDGs to a full stop during that period.", "tag": "Regulations"}, {"q": "When must position (nav) lights be on?", "a": "From sunset to sunrise.", "why": "91.209(a) requires lighted position lights sunset to sunrise (with an Alaska exception).", "tag": "Regulations", "choices": ["Civil twilight", "Sunset to sunrise", "One hour after sunset to one hour before sunrise"]}, {"q": "Special VFR basic requirements?", "a": "At least 1 SM visibility, clear of clouds within the controlled surface area.", "why": "91.157 allows SVFR with 1 SM and CoC. At night, pilot and aircraft must be IFR-capable (helicopters excepted).", "tag": "Regulations", "choices": ["3 SM and CoC", "1 SM and CoC", "1.5 SM and 500-1000-2000"]}, {"q": "When is Supplemental Oxygen required for crew in unpressurized aircraft >12,500 MSL?", "a": "If above 12,500 and up to 14,000 MSL for more than 30 minutes; continuously above 14,000 MSL.", "why": "91.211: >12,500‚Äì14,000 MSL for >30 minutes requires crew O2; >14,000 requires continuous use; >15,000 passengers must be offered.", "tag": "Regulations"}, {"q": "ADS-B Out is generally required‚Ä¶", "a": "In Class A, B, and C airspace; within the Class B Mode C veil; above 10,000 MSL (except below 2,500 AGL).", "why": "91.225 defines the ADS-B Out airspace, largely mirroring Mode C transponder requirements.", "tag": "Regulations"}, {"q": "Documents required on board (ARROW) include‚Ä¶", "a": "Airworthiness, Registration, Radio license (if international), Operating limitations/POH, Weight & Balance data.", "why": "Common PPL memory aid: ARROW; radio license only for international operations.", "tag": "Regulations", "choices": ["Airworthiness, Registration, POH, W&B", "Airworthiness, Registration, Radio (intl), POH/limits, W&B", "Registration only"]}, {"q": "Passenger-carrying recent experience (day) requires‚Ä¶", "a": "3 takeoffs and 3 landings in the same category/class within the preceding 90 days.", "why": "61.57(a). Touch-and-go landings count for day currency; night currency requires full-stop.", "tag": "Regulations"}, {"q": "When must anti-collision lights be used?", "a": "For all operations, if equipped, except when the PIC determines it‚Äôs in the interest of safety to turn them off.", "why": "91.209(b): Anti-collision (beacon/strobe) must be on if installed, with safety exception.", "tag": "Regulations"}, {"q": "When are seat belts required?", "a": "During taxi, takeoff, and landing; PIC must brief at all times per 91.107.", "why": "Passengers must be briefed and have seat belts fastened during taxi, takeoff, and landing; shoulder harness when installed.", "tag": "Regulations"}, {"q": "Night landing currency counts only if‚Ä¶", "a": "Landings were to a full stop during the 1 hr after sunset to 1 hr before sunrise.", "why": "61.57(b) requires full stops during the night window.", "tag": "Regulations"}, {"q": "Minimum safe altitude over congested area?", "a": "1,000 ft above highest obstacle within 2,000 ft horizontal distance.", "why": "91.119(b). Elsewhere: 500 ft AGL; over open water/sparsely populated: 500 ft away from any person, vessel, vehicle, or structure.", "tag": "Regulations"}, {"q": "Right-of-way: converging at same altitude (not head-on)", "a": "Aircraft to the other's right has right-of-way.", "why": "91.113: When converging (except head-on), the aircraft to the right has priority. Balloons > gliders > airships > powered aircraft.", "tag": "Regulations"}, {"q": "Right-of-way on final approach", "a": "Aircraft on final approach or landing has right-of-way; lower aircraft has priority but not to cut in front.", "why": "91.113(g). Be cautious of hazards like wake turbulence.", "tag": "Regulations"}, {"q": "LAHSO acceptance by student pilots?", "a": "Not recommended; accept only if trained and comfortable.", "why": "LAHSO is optional; aim guidance suggests students should decline if unsure.", "tag": "Operations"}, {"q": "Class B entry requires‚Ä¶", "a": "ATC clearance: explicitly \"Cleared into the Bravo\".", "why": "Unlike Class C/D, you need explicit clearance to enter Class B.", "tag": "Airspace", "choices": ["Two-way radio", "Cleared into the Bravo", "Transponder only"]}, {"q": "Class C entry requires‚Ä¶", "a": "Establish two-way radio communication before entry.", "why": "You need to hear your call sign from ATC; explicit \"cleared\" is not required for entry.", "tag": "Airspace", "choices": ["No radio", "Two-way radio", "Explicit clearance"]}, {"q": "Mode C veil means‚Ä¶", "a": "30 NM radius around Class B where transponder/ADS-B Out is required.", "why": "The Mode C veil surrounds primary Class B airports.", "tag": "Airspace"}, {"q": "Basic VFR weather minimums in Class B below 10,000 MSL", "a": "3 SM and clear of clouds.", "why": "91.155: Class B is 3 SM, CoC.", "tag": "Weather", "choices": ["1 SM & CoC", "3 SM & CoC", "3 SM & 500-1000-2000"]}, {"q": "Basic VFR in Class C/D/E below 10,000 MSL", "a": "3 SM, 500 below, 1000 above, 2000 horizontal.", "why": "Known as ‚Äú3-152.‚Äù", "tag": "Weather"}, {"q": "Basic VFR in Class G at/below 1,200 AGL (day)", "a": "1 SM and clear of clouds.", "why": "G near the surface allows lower minima by day.", "tag": "Weather"}, {"q": "Basic VFR in Class G at/below 1,200 AGL (night)", "a": "3 SM and 500-1000-2000.", "why": "At night, Class G aligns with Class E minima.", "tag": "Weather"}, {"q": "Basic VFR above 10,000 MSL (E or G)", "a": "5 SM, 1000 above, 1000 below, 1 SM horizontal.", "why": "Higher speed/traffic; need more separation.", "tag": "Weather"}, {"q": "Special VFR at night for airplanes requires‚Ä¶", "a": "Instrument rating and IFR-equipped aircraft (helicopters excepted).", "why": "91.157(c).", "tag": "Regulations"}, {"q": "When must nav lights be displayed for taxiing aircraft?", "a": "Sunset to sunrise when moving or in a night ops area.", "why": "91.209 covers aircraft moving/parked in night operations area.", "tag": "Regulations"}, {"q": "Vx vs Vy‚Äîwhat‚Äôs the difference?", "a": "Vx is best angle; Vy is best rate of climb.", "why": "Vx clears obstacles (most altitude per distance). Vy gets you to altitude quickest (per time).", "tag": "Airspeeds"}, {"q": "Effect of altitude on Vy?", "a": "Vy decreases with altitude.", "why": "Power available drops; the speed for best rate goes down.", "tag": "Airspeeds"}, {"q": "Effect of altitude on Vx?", "a": "Vx increases with altitude.", "why": "As thrust available falls, you need a higher angle of attack at a higher IAS to maximize climb angle.", "tag": "Airspeeds"}, {"q": "Va (maneuvering speed) depends on‚Ä¶", "a": "Weight; lower weight ‚Üí lower Va.", "why": "At lighter weights the wing reaches critical AoA at lower IAS; manufacturers publish a chart.", "tag": "Airspeeds"}, {"q": "VNO marks‚Ä¶", "a": "Top of green arc: maximum structural cruising speed.", "why": "Operate above VNO (yellow arc) only in smooth air.", "tag": "Airspeeds"}, {"q": "VNE is‚Ä¶", "a": "Never-exceed speed: red line.", "why": "Structural and flutter margins demand avoidance.", "tag": "Airspeeds"}, {"q": "Best glide is used for‚Ä¶", "a": "Engine failure to maximize range.", "why": "Gives greatest distance per altitude lost. Check POH.", "tag": "Performance"}, {"q": "Forward CG does what to stall speed?", "a": "Increases stall speed.", "why": "More tail-down force required ‚Üí higher wing loading.", "tag": "Weight & Balance", "choices": ["Increases", "Decreases", "No change"]}, {"q": "Aft CG effect on stability?", "a": "Decreases longitudinal stability and can reduce stall speed.", "why": "Tail needs less downforce; can make recovery harder.", "tag": "Weight & Balance"}, {"q": "High density altitude effect on takeoff roll?", "a": "Longer takeoff roll, reduced climb performance.", "why": "Thin air reduces thrust, power, and lift.", "tag": "Performance"}, {"q": "Effect of temperature on density altitude", "a": "Hotter air ‚Üí higher density altitude.", "why": "Warm air is less dense; combines with pressure/humidity.", "tag": "Performance"}, {"q": "Ground effect does what on liftoff/landing?", "a": "Reduces induced drag near the surface.", "why": "Wingtip vortices are disrupted; can cause premature liftoff and float.", "tag": "Aerodynamics"}, {"q": "Left-turning tendencies on takeoff roll are mainly‚Ä¶", "a": "P-factor, torque, spiraling slipstream, gyroscopic precession.", "why": "Use right rudder to keep centerline.", "tag": "Aerodynamics"}, {"q": "Accelerated stall happens when‚Ä¶", "a": "Stall occurs at a higher IAS under higher load factor (e.g., steep turns).", "why": "Critical AoA unchanged; required IAS increases with G.", "tag": "Aerodynamics"}, {"q": "Why avoid high manifold pressure with low RPM?", "a": "Can over-stress the engine/prop system.", "why": "Set RPM before MP on power up; reduce MP before RPM when pulling back.", "tag": "Engines"}, {"q": "Carburetor ice is most likely when‚Ä¶", "a": "Temperature ~20‚Äì70¬∞F and high humidity.", "why": "Venturi + fuel vaporization cools air; ice can form above 0¬∞C.", "tag": "Engines"}, {"q": "Shock cooling concern?", "a": "Rapid CHT drop from aggressive power reduction.", "why": "Use step-downs in descent; manage mixture/power.", "tag": "Engines"}, {"q": "Mixture on the ground at high DA?", "a": "Lean for taxi to prevent plug fouling.", "why": "Restore for takeoff per POH.", "tag": "Engines"}, {"q": "Detonation is‚Ä¶", "a": "Uncontrolled, explosive combustion.", "why": "High CHT/roughness; avoid by proper mixture/grade and power settings.", "tag": "Engines"}, {"q": "Preignition is‚Ä¶", "a": "Ignition before the spark.", "why": "Caused by hot spots (glowing plugs); results in power loss/overheat.", "tag": "Engines"}, {"q": "Stable air tends to produce‚Ä¶", "a": "Poor visibility, smooth air, stratiform clouds, steady precipitation.", "why": "Vertical motion is resisted; widespread, layered weather.", "tag": "Weather"}, {"q": "Unstable air tends to produce‚Ä¶", "a": "Good visibility, turbulence, cumuliform clouds, showery precipitation.", "why": "Vertical motion enhanced; convective activity.", "tag": "Weather"}, {"q": "Warm front typical weather?", "a": "Stratus clouds, steady precipitation, poor vis ahead of the front.", "why": "Warm air overruns cool air gradually.", "tag": "Weather"}, {"q": "Cold front typical weather?", "a": "Cumuliform clouds, showery precipitation, gusty winds, possible thunderstorms.", "why": "Cold air mass forces warm air up rapidly.", "tag": "Weather"}, {"q": "Thunderstorm life cycle stages?", "a": "Cumulus, mature, dissipating.", "why": "Updraft-dominated ‚Üí up/down drafts ‚Üí downdraft-dominated.", "tag": "Weather"}, {"q": "Microburst hazard is greatest‚Ä¶", "a": "In the mature/dissipating stage near thunderstorms.", "why": "Strong downdrafts and wind shear near the ground.", "tag": "Weather"}, {"q": "Radiation fog forms when‚Ä¶", "a": "Clear night, light wind, ground cools causing air to reach dew point.", "why": "Common in valleys after sunset.", "tag": "Weather"}, {"q": "Advection fog forms when‚Ä¶", "a": "Warm, moist air moves over a cooler surface.", "why": "Coastal regions with onshore flow.", "tag": "Weather"}, {"q": "Icing most dangerous in which cloud type?", "a": "Cumulus/cumulonimbus (convective) for rapid icing.", "why": "Supercooled droplets, strong vertical motion.", "tag": "Weather"}, {"q": "Clear ice vs rime ice difference?", "a": "Clear ice is glossy/heavy from large droplets; rime is milky/rough from small droplets.", "why": "Temperature and droplet size influence accretion.", "tag": "Weather"}, {"q": "Frost danger on wings?", "a": "Disrupts smooth airflow; can greatly increase stall speed.", "why": "Even small amounts reduce lift significantly.", "tag": "Weather"}, {"q": "METAR wind 27012G20KT means‚Ä¶", "a": "Wind from 270¬∞ at 12 knots, gusting 20.", "why": "Direction is magnetic in METARs (U.S.).", "tag": "Weather"}, {"q": "TAF TEMPO group indicates‚Ä¶", "a": "Temporary fluctuations expected for less than one hour each and less than half the period.", "why": "Short-lived changes like showers or TS.", "tag": "Weather"}, {"q": "AIRMET vs SIGMET?", "a": "AIRMET for widespread moderate hazards; SIGMET for significant severe hazards not associated with convective storms.", "why": "Convective SIGMET is for severe TS, hail, tornadoes, etc.", "tag": "Weather"}, {"q": "Runway numbers correspond to‚Ä¶", "a": "Magnetic runway direction rounded to nearest 10¬∞.", "why": "Runway 18 ‚âà 180¬∞; opposite end ‚âà 36.", "tag": "Airports"}, {"q": "Displaced threshold means‚Ä¶", "a": "You may taxi, takeoff, and rollout on the displaced portion, but not land on it.", "why": "Used to provide obstacle clearance or pavement protection.", "tag": "Airports"}, {"q": "Hold short marking looks like‚Ä¶", "a": "Two solid and two dashed yellow lines; stop before the solid lines.", "why": "Dashed lines on the runway side.", "tag": "Airports"}, {"q": "Runway hold position sign colors?", "a": "White characters on red background.", "why": "Mandatory instruction signs are white-on-red.", "tag": "Airports", "choices": ["White on red", "Black on yellow", "Yellow on black"]}, {"q": "VOR radials are oriented to‚Ä¶", "a": "Magnetic north.", "why": "Radial numbers reference magnetic bearing from the station.", "tag": "Navigation"}, {"q": "To track TO a VOR on the 090 radial, you fly‚Ä¶", "a": "A 270¬∞ course to the station.", "why": "Radials are FROM the station; the 090 radial lies east; inbound reciprocal is 270.", "tag": "Navigation"}, {"q": "MEF (Maximum Elevation Figure) on a sectional shows‚Ä¶", "a": "Highest elevation (terrain/obstacle) in that quadrangle.", "why": "Adds a buffer to the highest feature.", "tag": "Navigation"}, {"q": "Magnetic variation is‚Ä¶", "a": "Difference between true and magnetic north.", "why": "East is least (subtract), West is best (add).", "tag": "Navigation"}, {"q": "Pilotage means‚Ä¶", "a": "Navigation by visual reference to landmarks.", "why": "Use sectional features and checkpoints.", "tag": "Navigation"}, {"q": "Dead reckoning means‚Ä¶", "a": "Navigation by time, speed, distance, and heading.", "why": "Correct for wind to estimate groundspeed and ETA.", "tag": "Navigation"}, {"q": "Pitot tube provides which input?", "a": "Ram air for the airspeed indicator.", "why": "ASI compares pitot (total) to static to compute dynamic pressure.", "tag": "Instruments"}, {"q": "Static port feeds which instruments?", "a": "Altimeter, VSI, and airspeed indicator.", "why": "They need ambient static pressure.", "tag": "Instruments"}, {"q": "Blockage: pitot tube blocked, drain hole open?", "a": "ASI reads zero.", "why": "Pressure vents; no differential.", "tag": "Instruments"}, {"q": "Blockage: pitot + drain blocked?", "a": "ASI acts like an altimeter (freezes higher in climb, lower in descent).", "why": "Trapped pressure behaves like static reference.", "tag": "Instruments"}, {"q": "Static port blocked (pitot normal)?", "a": "ASI inaccurate, altimeter and VSI freeze.", "why": "No true ambient reference; ASI errors with altitude changes.", "tag": "Instruments"}, {"q": "Gyro instruments typically include‚Ä¶", "a": "Attitude indicator, heading indicator, and turn coordinator.", "why": "Vacuum or electric driven gyros.", "tag": "Instruments"}, {"q": "Standard rate turn is‚Ä¶", "a": "3¬∞ per second (2 minutes for 360¬∞).", "why": "Turn coordinator marks standard rate for instrument procedures.", "tag": "Instruments"}, {"q": "Magnetic dip errors cause the compass to‚Ä¶", "a": "Lead on turns from south, lag on turns from north.", "why": "ANDS: Accelerate North, Decelerate South on east/west headings; turning errors due to dip.", "tag": "Instruments"}, {"q": "IMSAFE checklist stands for‚Ä¶", "a": "Illness, Medication, Stress, Alcohol, Fatigue, Eating/Emotion.", "why": "Personal readiness risk check.", "tag": "Human Factors"}, {"q": "Hazardous attitude: Anti-authority antidote?", "a": "‚ÄúFollow the rules. They are usually right.‚Äù", "why": "Other attitudes: Impulsivity, Invulnerability, Macho, Resignation.", "tag": "Human Factors"}, {"q": "Somatogravic illusion feels like‚Ä¶", "a": "On rapid acceleration, a false pitch-up sensation.", "why": "Can cause a dangerous nose-down push; trust instruments.", "tag": "Human Factors"}, {"q": "Autokinesis is‚Ä¶", "a": "A stationary light appears to move at night.", "why": "Fixation causes illusion; scan and avoid prolonged stare.", "tag": "Human Factors"}, {"q": "Graveyard spiral sign is‚Ä¶", "a": "Constant turn felt as wings-level; when you level, you feel a turn the other way.", "why": "Vestibular system adapts; trust instruments.", "tag": "Human Factors"}, {"q": "Hypoxia early symptom?", "a": "Euphoria and impaired judgment.", "why": "Brain is sensitive to O2 shortage.", "tag": "Physiology"}, {"q": "Carbon monoxide poisoning signs?", "a": "Headache, dizziness, cherry-red lips/skin (late).", "why": "Use cabin heat cautiously if exhaust leak suspected; open vents, land.", "tag": "Physiology"}, {"q": "Engine failure after takeoff best action?", "a": "Pitch for best glide, lower nose, land ahead (within ~30¬∞) if low.", "why": "Avoid the ‚Äúimpossible turn.‚Äù Fly the airplane first.", "tag": "Emergency"}, {"q": "Fire in flight‚Äîfirst steps?", "a": "Mixture idle cut-off, fuel off, master off (as appropriate), establish glide, land ASAP.", "why": "Memory items vary by POH; prioritize extinguishing and landing.", "tag": "Emergency"}, {"q": "Electrical fire in flight?", "a": "Master off, vents closed then open to clear smoke, use extinguisher, land ASAP.", "why": "Isolate power; consult POH for exact steps.", "tag": "Emergency"}, {"q": "Spin recovery (general) uses‚Ä¶", "a": "PARE: Power idle, Ailerons neutral, Rudder full opposite, Elevator brisk forward.", "why": "Always follow POH; recover promptly.", "tag": "Emergency"}, {"q": "ELT must be inspected‚Ä¶", "a": "Every 12 calendar months; replace/recharge battery after 1 hour cumulative use or 50% useful life.", "why": "91.207.", "tag": "Regulations"}, {"q": "Annual vs 100-hour inspection?", "a": "Annual required for all; 100-hour required if carrying passengers for hire or flight instruction for hire.", "why": "100-hour can be exceeded by up to 10 hours for ferry to inspection.", "tag": "Maintenance"}, {"q": "Preventive maintenance a pilot may perform includes‚Ä¶", "a": "Simple, noncomplex tasks like oil change, tire replacement (refer Part 43 Appx A(c)).", "why": "Must be owner/operator and log the work.", "tag": "Maintenance"}, {"q": "Altimeter/static system test interval for IFR?", "a": "Every 24 calendar months.", "why": "Pitot-static/altimeter tests required for IFR flight in controlled airspace.", "tag": "Maintenance"}, {"q": "Transponder inspection interval?", "a": "Every 24 calendar months.", "why": "91.413.", "tag": "Maintenance"}, {"q": "Standard traffic pattern turns are‚Ä¶", "a": "Left turns unless otherwise published.", "why": "Check Chart Supplement/sectional for right patterns.", "tag": "Operations"}, {"q": "Uncontrolled airport pattern entry?", "a": "Enter on the 45¬∞ to the downwind at pattern altitude.", "why": "AIM recommendation for predictability.", "tag": "Operations"}, {"q": "Crosswind taxi control into a strong wind uses‚Ä¶", "a": "Aileron into the wind; elevator position depends on wind angle (climb into, dive away).", "why": "Prevent lifting the upwind wing and tail strike.", "tag": "Operations"}, {"q": "Short-field takeoff technique includes‚Ä¶", "a": "Use all available runway, hold brakes, apply full power, rotate at recommended speed, climb at Vx until obstacle is cleared.", "why": "Maximizes performance over obstacles.", "tag": "Operations"}, {"q": "Soft-field takeoff technique includes‚Ä¶", "a": "Keep weight off nosewheel, do not stop, lift off into ground effect, accelerate, then climb.", "why": "Prevents getting stuck and reduces drag.", "tag": "Operations"}, {"q": "Landing beyond a large aircraft‚Äôs touchdown point helps avoid‚Ä¶", "a": "Wake turbulence.", "why": "Vortices sink and move with the wind; stay above and upwind.", "tag": "Airmanship"}, {"q": "Night illusions on final can make you‚Ä¶", "a": "High over dark terrain (black hole) or low over bright/runway lights.", "why": "Trust instruments/PAPI/VASI.", "tag": "Human Factors"}, {"q": "PAPI four white lights mean‚Ä¶", "a": "Too high.", "why": "2 white/2 red is on glidepath; more white = high, more red = low.", "tag": "Airports"}, {"q": "VASI red over red means‚Ä¶", "a": "Too low.", "why": "White over white: high; red over white: alright.", "tag": "Airports"}, {"q": "If alternator fails (low volts light), first do‚Ä¶", "a": "Shed nonessential loads, attempt reset per POH, land soon.", "why": "Battery-only ops are limited; conserve power.", "tag": "Emergency"}, {"q": "Before engine start, beacon should be‚Ä¶", "a": "On prior to engine start (if equipped).", "why": "Warns others the engine may start or is running.", "tag": "Airmanship"}, {"q": "When is ‚Äúnight‚Äù for logging night flight time?", "a": "Between the end of evening civil twilight and the beginning of morning civil twilight.", "why": "Regulatory definition differs from light/currency rules.", "tag": "Regulations"}, {"q": "When must nav lights be on for parked/moving aircraft at night ops area?", "a": "Sunset to sunrise if in, or in dangerous proximity to, a night flight operations area.", "why": "91.209(a)(2).", "tag": "Regulations"}];

/* ---------- Storage Keys ---------- */
const K_DECK="ppl_super_deck_v1";
const K_STATS="ppl_super_stats_v1";
const K_SRS="ppl_super_srs_v1";
const K_POMO="ppl_pomo_blocks_v1";
const K_TODO="ppl_todo_today_v1";

/* ---------- State ---------- */
let userDeck = load(K_DECK, []);
let deck = attachIds([...SAMPLE, ...userDeck]);
let i=0, show=false, streak=0, correct=0, wrong=0;
let studyFilterTag="", studySearch="";
let srsMap = load(K_SRS, {}); // id -> {bucket,next_due,last, seen}
updateStatsCount();

function attachIds(arr){
  return arr.map(c => ({id:c.id||idgen(), q:c.q, a:c.a, choices:c.choices, why:c.why, tag:c.tag||"General"}));
}
function rebuildDeck(){ deck = attachIds([...SAMPLE, ...userDeck]); applyFilters(); fillTags() }

/* ---------- Tags & Filters ---------- */
function fillTags(){
  const tags = [...new Set(deck.map(c=>c.tag||"General"))].sort();
  const sel = $('#filterTag'); const examSel = $('#examTag');
  const currentF = sel.value; const currentE = examSel.value;
  sel.innerHTML='<option value="">All Topics</option>'+tags.map(t=>`<option>${t}</option>`).join('');
  examSel.innerHTML='<option value="">All Topics</option>'+tags.map(t=>`<option>${t}</option>`).join('');
  if(tags.includes(currentF)) sel.value=currentF;
  if(tags.includes(currentE)) examSel.value=currentE;
}
function applyFilters(){
  let arr = attachIds([...SAMPLE, ...userDeck]);
  if(studyFilterTag) arr = arr.filter(c=>(c.tag||"General")===studyFilterTag);
  if(studySearch){
    const q = studySearch.toLowerCase();
    arr = arr.filter(c => (c.q+" "+(c.a||"")+" "+(c.why||"")).toLowerCase().includes(q));
  }
  deck = arr;
  i = Math.min(i, Math.max(0, deck.length-1));
  renderCard();
}

/* ---------- Render Study Card ---------- */
function renderCard(){
  $('#total').textContent = deck.length;
  $('#idx').textContent = deck.length? (i+1) : 0;
  $('#ok').textContent = correct; $('#bad').textContent = wrong; $('#streak').textContent = streak;
  const c = deck[i];
  if(!c){ $('#q').textContent="No cards match your filter. Clear filters."; $('#a').style.display='none'; $('#choices').innerHTML=''; $('#whyBox').style.display='none'; $('#topicBadge').textContent='‚Äî'; return; }
  $('#topicBadge').textContent = c.tag||"General";
  $('#q').textContent = c.q;
  const ans = $('#a'); ans.textContent = "Answer: " + c.a; ans.style.display = show ? 'block' : 'none';
  const box = $('#choices'); box.innerHTML='';
  if(c.choices && c.choices.length){
    c.choices.forEach((ch,idx)=>{
      const b = document.createElement('button');
      b.textContent = ch; b.onclick = ()=>{ show=true; ans.style.display='block'; if(ch.trim().toLowerCase()===c.a.trim().toLowerCase()){ b.style.borderColor='var(--ok)'; } else { b.style.borderColor='var(--err)' } };
      box.appendChild(b);
    });
    box.style.display='grid';
  } else box.style.display='none';
  if(c.why){ $('#why').textContent = c.why; $('#whyBox').style.display='block'; } else { $('#whyBox').style.display='none'; }
}

/* ---------- Study Controls ---------- */
$('#show').onclick = ()=>{ show=!show; $('#a').style.display = show?'block':'none'; };
$('#next').onclick = ()=>{ i=(i+1)%Math.max(1,deck.length); show=false; renderCard() };
$('#prev').onclick = ()=>{ i=(i-1+Math.max(1,deck.length))%Math.max(1,deck.length); show=false; renderCard() };
$('#shuffle').onclick = ()=>{ deck = shuffle(deck); i=0; show=false; renderCard() };
$('#right').onclick = ()=>{ correct++; streak++; updateStatsCount(); srsMark(deck[i]?.id,true); $('#ok').textContent=correct; $('#streak').textContent=streak; $('#next').click(); };
$('#wrong').onclick = ()=>{ wrong++; streak=0; updateStatsCount(); srsMark(deck[i]?.id,false); $('#bad').textContent=wrong; $('#streak').textContent=streak; };

$('#filterTag').onchange = (e)=>{ studyFilterTag = e.target.value; applyFilters() };
$('#searchBox').oninput = (e)=>{ studySearch = e.target.value; applyFilters() };

$('#resetStats').onclick = ()=>{ correct=wrong=streak=0; updateStatsCount(); renderCard() };

/* ---------- Add/Edit ---------- */
$('#addBtn').onclick = ()=>{
  const q = prompt("Question?"); if(!q) return;
  const a = prompt("Answer?"); if(!a) return;
  const choices = prompt("Choices (optional, separate with ;)","");
  const why = prompt("Why (simple explanation)?","");
  const tag = prompt("Topic/Tag? (e.g., Airspeeds, Weather)","General") || "General";
  const card = {id:idgen(), q,a,why,tag};
  if(choices && choices.trim()) card.choices = choices.split(';').map(s=>s.trim()).filter(Boolean);
  userDeck.push(card); save(K_DECK,userDeck); rebuildDeck();
  i = deck.length-1; renderCard();
};
$('#editBtn').onclick = ()=>{
  const c = deck[i]; if(!c) return;
  const q = prompt("Edit Question:", c.q); if(!q) return;
  const a = prompt("Edit Answer:", c.a); if(!a) return;
  const choices = prompt("Edit Choices (; separated, blank for none):", (c.choices||[]).join(';'));
  const why = prompt("Edit Why (simple):", c.why||"");
  const tag = prompt("Edit Topic/Tag:", c.tag||"General") || "General";
  const updated={...c,q,a,why,tag};
  if(choices && choices.trim()) updated.choices=choices.split(';').map(s=>s.trim()).filter(Boolean); else delete updated.choices;
  // update in userDeck if exists, else in SAMPLE is not editable persistently; push to userDeck
  const idx = userDeck.findIndex(x=>x.id===c.id);
  if(idx>=0) userDeck[idx]=updated; else userDeck.push(updated);
  save(K_DECK,userDeck); rebuildDeck(); renderCard();
};

/* ---------- Import/Export ---------- */
$('#importBtn').onclick = ()=>$('#fileInput').click();
$('#fileInput').onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text = await f.text();
  let arr=[];
  if(f.name.endsWith('.csv')) arr = csvParse(text);
  else{
    try{ arr = JSON.parse(text) }catch{ alert('Invalid file. Use JSON array or CSV.'); return; }
  }
  if(!Array.isArray(arr)){ alert('Invalid data format.'); return; }
  const clean = arr.map(o=>({id:idgen(), q:o.q||o.question, a:o.a||o.answer, choices:o.choices, why:o.why, tag:o.tag||o.topic||"Imported"}))
                  .filter(x=>x.q && x.a);
  userDeck = attachIds([...userDeck, ...clean]);
  save(K_DECK,userDeck); rebuildDeck(); i=0; renderCard();
  alert(`Imported ${clean.length} cards.`);
};
$('#exportBtn').onclick = ()=>{
  const data = JSON.stringify(userDeck, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ppl_cards_export.json';
  a.click();
};

/* ---------- Help Modal and Paste Import ---------- */
$('#helpBtn').onclick = ()=>$('#helpModal').style.display='flex';
$('#closeHelp').onclick = ()=>$('#helpModal').style.display='none';
$('#importFromPaste').onclick = ()=>{
  const txt = $('#pasteArea').value;
  if(!txt.trim()) return;
  const arr = csvParse(txt);
  const clean = arr.map(o=>({id:idgen(), q:o.q||o.question, a:o.a||o.answer, choices:o.choices, why:o.why, tag:o.tag||o.topic||"Imported"}))
                  .filter(x=>x.q && x.a);
  userDeck = attachIds([...userDeck, ...clean]);
  save(K_DECK,userDeck); rebuildDeck(); i=0; renderCard();
  alert(`Imported ${clean.length} cards from paste.`);
};

/* ---------- SRS (Leitner) ---------- */
const BUCKET_DELAYS = {1:1,2:2,3:4,4:7,5:14}; // days
function srsGet(id){
  if(!srsMap[id]) srsMap[id]={bucket:1,next_due:todayStr(),last:null,seen:0};
  return srsMap[id];
}
function srsMark(id, ok){
  if(!id) return;
  const s = srsGet(id);
  s.seen=(s.seen||0)+1;
  s.last=todayStr();
  if(ok){ s.bucket=Math.min(5,(s.bucket||1)+1) } else { s.bucket=1 }
  const add=BUCKET_DELAYS[s.bucket]||1;
  const d=new Date(); d.setDate(d.getDate()+add); s.next_due=todayStr(d);
  srsMap[id]=s; save(K_SRS,srsMap); updateSrsStats();
}
function srsDueList(){
  const today = todayStr();
  return deck.filter(c => (srsGet(c.id).next_due <= today));
}
function updateSrsStats(){
  const due = srsDueList();
  $('#dueToday').textContent = due.length;
  const all = deck.map(c=>srsGet(c.id));
  $('#srsTotal').textContent = all.length;
  const avg = all.reduce((a,b)=>a+(b.bucket||1),0)/Math.max(1,all.length);
  $('#avgBucket').textContent = avg.toFixed(2);
  const next = all.map(s=>s.next_due).sort()[0];
  $('#nextDue').textContent = next || '‚Äî';
}
let srsQueue = [];
let srsIdx = 0; let srsShown=false;
function srsRender(){
  if(srsQueue.length===0){ srsQueue = srsDueList(); srsIdx=0; srsShown=false; }
  $('#srsArea').innerHTML='';
  const c = srsQueue[srsIdx];
  if(!c){ $('#srsArea').innerHTML='<div class="small ok">No due cards. Great job‚Äîcome back later!</div>'; return; }
  const topic = document.createElement('div'); topic.className='badge'; topic.textContent=c.tag||"General";
  const q = document.createElement('div'); q.className='q'; q.textContent=c.q;
  const a = document.createElement('div'); a.className='a'; a.textContent="Answer: "+c.a; a.style.display = srsShown?'block':'none';
  const why = document.createElement('div'); why.className='small'; why.textContent=c.why||''; why.style.display = srsShown && c.why ? 'block':'none';
  const choices = document.createElement('div'); choices.className='mc';
  if(c.choices && c.choices.length){
    c.choices.forEach(ch=>{
      const b=document.createElement('button'); b.textContent=ch; b.onclick=()=>{ srsShown=true; a.style.display='block'; if(ch.trim().toLowerCase()===c.a.trim().toLowerCase()) b.style.borderColor='var(--ok)'; else b.style.borderColor='var(--err)'; if(c.why){ why.style.display='block' } };
      choices.appendChild(b);
    });
  }
  $('#srsArea').append(topic,q,choices,a,why);
}
$('#srsShow').onclick=()=>{ srsShown=!srsShown; srsRender() };
$('#srsRight').onclick=()=>{ const c=srsQueue[srsIdx]; if(!c) return; srsMark(c.id,true); srsIdx++; srsShown=false; srsRender() };
$('#srsWrong').onclick=()=>{ const c=srsQueue[srsIdx]; if(!c) return; srsMark(c.id,false); srsIdx++; srsShown=false; srsRender() };
$('#srsSkip').onclick=()=>{ srsIdx++; srsShown=false; srsRender() };

/* ---------- Exam Mode ---------- */
let examTimer=null, examSecs=0, examSet=[], examAnswers={};
function startExam(){
  const tag = $('#examTag').value;
  const count = Math.min(parseInt($('#examCount').value||30,10), deck.length);
  examSet = shuffle(deck.filter(c=>!tag || (c.tag||"General")===tag)).slice(0,count);
  examAnswers={};
  examSecs = parseInt($('#examTime').value,10)*60;
  $('#examArea').innerHTML = examSet.map((c,idx)=>renderExamQ(c,idx)).join('');
  $('#examResult').innerHTML = '';
  $('#examInfo').innerHTML = `Questions: <b>${count}</b> ¬∑ Time: <b><span id="examClock"></span></b>`;
  $('#endExam').style.display='inline-block';
  if(examTimer) clearInterval(examTimer);
  examTimer = setInterval(()=>{
    examSecs--; $('#examClock').textContent = fmt(examSecs);
    if(examSecs<=0){ clearInterval(examTimer); gradeExam(); }
  },1000);
  $('#examClock').textContent = fmt(examSecs);
}
function fmt(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}` }
function renderExamQ(c, idx){
  const choices = (c.choices&&c.choices.length? c.choices.map((ch,j)=>`
    <label style="display:block;margin:4px 0">
      <input type="radio" name="q${idx}" value="${String(j)}"> ${ch}
    </label>`).join('') : `<input type="text" data-free="q${idx}" placeholder="Type answer‚Ä¶">`);
  return `<div class="card" style="margin:10px 0">
    <div class="badge">${c.tag||"General"}</div>
    <div class="q">${idx+1}. ${c.q}</div>
    <div>${choices}</div>
  </div>`;
}
function gradeExam(){
  if(examTimer){ clearInterval(examTimer); examTimer=null; }
  // collect answers
  examSet.forEach((c,idx)=>{
    const radios = $$(`input[name="q${idx}"]`);
    if(radios.length){
      const picked = radios.find(r=>r.checked);
      examAnswers[idx] = picked ? Number(picked.value) : -1;
    }else{
      const el = $(`[data-free="q${idx}"]`);
      examAnswers[idx] = (el?.value||'').trim();
    }
  });
  // score
  let right=0, wrongN=0; const rows=[];
  examSet.forEach((c,idx)=>{
    let ok=false, chosen=null;
    if(c.choices && c.choices.length){
      const idxAns = c.choices.findIndex(x=>x.trim().toLowerCase()===c.a.trim().toLowerCase());
      chosen = examAnswers[idx];
      ok = (chosen===idxAns);
    }else{
      chosen = String(examAnswers[idx]||'').toLowerCase();
      ok = (chosen === c.a.trim().toLowerCase());
    }
    if(ok) right++; else wrongN++;
    rows.push({no:idx+1, topic:c.tag||"General", q:c.q, your:(c.choices&&c.choices.length)? (c.choices[chosen]??'(blank)') : (chosen||'(blank)'), correct:c.a, why:c.why||'' , ok});
  });
  const pct = Math.round(100*right/Math.max(1,examSet.length));
  $('#examResult').innerHTML = `<div class="kpis">
    <div class="kpi">Score: <b>${right}/${examSet.length} (${pct}%)</b></div>
    <div class="kpi ${pct>=70?'ok':(pct>=60?'warn':'err')}">${pct>=70?'‚úÖ Likely Pass Range':'‚ö†Ô∏è Keep Practicing'}</div>
  </div>
  <div class="sep"></div>
  <table><thead><tr><th>#</th><th>Topic</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Why</th><th>‚úì</th></tr></thead>
  <tbody>${rows.map(r=>`<tr><td>${r.no}</td><td>${r.topic}</td><td>${r.q}</td><td>${r.your}</td><td>${r.correct}</td><td class="small">${r.why}</td><td>${r.ok?'‚úì':'‚Äî'}</td></tr>`).join('')}</tbody></table>`;
  $('#endExam').style.display='none';
}
$('#startExam').onclick = startExam;
$('#endExam').onclick = gradeExam;

/* ---------- Stats ---------- */
function updateStatsCount(){ save(K_STATS,{correct,wrong,streak}); }
(function initStats(){ const s=load(K_STATS,{correct:0,wrong:0,streak:0}); correct=s.correct; wrong=s.wrong; streak=s.streak; })();

/* ---------- Pomodoro ---------- */
let secs=25*60, tick=null, blocks=Number(load(K_POMO,0));
function drawClock(){ $('#clock').textContent=fmt(secs) }
function start(){ if(tick) return; tick=setInterval(()=>{ secs--; drawClock(); if(secs<=0){ clearInterval(tick); tick=null; if($('#mode').value!=='5' && $('#mode').value!=='10'){ blocks++; save(K_POMO,blocks); $('#blocks').textContent=blocks } try{ const o=new (window.AudioContext||window.webkitAudioContext)(); const osc=o.createOscillator(); osc.connect(o.destination); osc.frequency.value=880; osc.start(); setTimeout(()=>{osc.stop();o.close()},350) }catch(e){} } },1000) }
function stop(){ if(tick){ clearInterval(tick); tick=null } }
$('#blocks').textContent=blocks; drawClock();
$('#startStop').onclick=()=>{ if(tick){ stop(); $('#startStop').textContent='Start' } else { start(); $('#startStop').textContent='Stop' } };
$('#reset').onclick=()=>{ stop(); secs=Number($('#mode').value)*60; drawClock(); $('#startStop').textContent='Start' };
$('#mode').onchange=()=>{ stop(); secs=Number($('#mode').value)*60; drawClock(); $('#startStop').textContent='Start' };

/* ---------- To-Do ---------- */
let todos = load(K_TODO, []);
function renderTodos(){
  const ul = $('#todos'); ul.innerHTML='';
  todos.forEach((t,idx)=>{
    const li = document.createElement('li'); li.style.display='flex'; li.style.alignItems='center'; li.style.gap='8px'; li.style.padding='6px 0'; li.style.borderBottom='1px dashed var(--edge)';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.onchange=()=>{ t.done=cb.checked; save(K_TODO,todos); renderTodos() };
    const txt = document.createElement('div'); txt.textContent=t.text; txt.style.flex='1'; if(t.done) txt.style.textDecoration='line-through';
    txt.onclick=()=>{ t.done=!t.done; save(K_TODO,todos); renderTodos() };
    const del = document.createElement('button'); del.textContent='üóëÔ∏è'; del.onclick=()=>{ todos.splice(idx,1); save(K_TODO,todos); renderTodos() };
    li.append(cb, txt, del); ul.appendChild(li);
  });
}
renderTodos();
$('#addTodo').onclick=()=>{ const v=$('#todoInput').value.trim(); if(!v) return; todos.push({text:v,done:false}); save(K_TODO,todos); $('#todoInput').value=''; renderTodos(); };

/* ---------- Tabs ---------- */
$$('.tab').forEach(b=>b.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); ['study','exam','srs','timer','todo'].forEach(id=>$('#'+id).style.display=(b.dataset.tab===id?'block':'none')); if(b.dataset.tab==='srs'){ updateSrsStats(); srsRender(); } });

/* ---------- Keyboard Shortcuts ---------- */
window.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
  if(e.code==='Space'){ e.preventDefault(); $('#show').click(); }
  if(e.key==='ArrowRight'){ $('#next').click() }
  if(e.key==='ArrowLeft'){ $('#prev').click() }
  if(e.key.toLowerCase()==='y'){ $('#right').click() }
  if(e.key.toLowerCase()==='n'){ $('#wrong').click() }
  if(['1','2','3','4'].includes(e.key)){ const btn=$$('#choices button')[Number(e.key)-1]; if(btn) btn.click(); }
});

/* ---------- Init ---------- */
rebuildDeck(); renderCard(); updateSrsStats(); srsRender();
</script>
</body>
</html>
